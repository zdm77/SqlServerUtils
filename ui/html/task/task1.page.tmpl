<head>
    <script src="/static/js/xlsx.min.js"/>
    <script>
    </script>
</head>
{{template "base" .}}

{{define "main"}}
    <main class="form-main">
        <div class="card">
            <div class="card-header">
                Задача: Загрузка Excel
            </div>
            <form id='form'
                  encType="multipart/form-data">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <div class="row">
                            <div class="col-sm">
                                <label for="task" class="form-label">Выбор задачи</label>
                                <select id="taskId" name="task" class="form-select"/>
                                <br/>
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item">
                        <div class="row">
                            <div class="col-sm">
                                <label for="formFile" class="form-label">Файл для загрузки</label>
                                <input class="form-control" type="file" id="file_upload">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="upload()">2. Выполнить</button>
                    </li>
                    <li class="list-group-item">
                        <div class="row">
                            <div class="col-sm">
                                <div class="container  table-responsive">
                                    <table id="json_data"
                                           class="table table-striped table-bordered table-sm table-responsive"></table>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </form>
            <button class="btn" onclick="uploadToServ()">1. Загрузить Excel</button>
        </div>
        <script>
            let task = {}
            let tasks = []
            let headers = []
            let data = []
            let selectTask = document.getElementById('taskId')
            selectTask.addEventListener('change', function () {
                let id = selectTask.value
                for (let t of tasks) {
                    if (t.id == id) {
                        task = t
                    }
                }

            });
            getTasks()

            function uploadToServ() {

                //  const form = document.getElementById('form')
                const form = document.querySelector('form')
                console.log(form)
                const data = new FormData(form);
                let files = document.getElementById('file_upload').files
                console.log(files[0])
                data.append('file', files[0]);
                data.append('task_id', task.id);
                fetch('/api/upload',
                    {
                        method: 'POST',
                        body: data,
                    })
                    .then(response => response.json())
                    .then((response) => {

                    });
            }

            function getTasks() {
                tasks = []
                let htmlD = ''
                fetch('/api/task-list',
                    {
                        method: 'PUT',
                        headers: {
                            "Content-Type": "application/json"
                        },
                    })
                    .then(response => response.json())
                    .then((response) => {
                        for (let item of response) {
                            tasks.push(item)
                            htmlD += '<option value="' + item.id + '">' + item.name + '</option>'

                        }
                        task = tasks[0]
                        selectTask.innerHTML = htmlD
                    });

            }

            function upload() {
                var files = document.getElementById('file_upload').files;
                if (files.length == 0) {
                    alert("Please choose any file...");
                    return;
                }
                var filename = files[0].name;
                var extension = filename.substring(filename.lastIndexOf(".")).toUpperCase();
                if (extension == '.XLS' || extension == '.XLSX') {
                    //Here calling another method to read excel file into json
                    excelFileToJSON(files[0]);
                } else {
                    alert("Please select a valid excel file.");
                }
            }

            //Method to read excel file and convert it into JSON
            function excelFileToJSON(file) {
                try {
                    let reader = new FileReader();
                    reader.readAsBinaryString(file);
                    reader.onload = function (e) {
                        let dataT = e.target.result;
                        let workbook = XLSX.read(dataT, {
                                type: 'binary'
                            }
                        );

                        headers = []
                        data = []
                        let firstSheetName = workbook.SheetNames[0];
                        //reading only first sheet data
                        let jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName]);
                        let myMap = new Map(Object.entries(jsonData[task.str_header - 2]));
                        let counter = 0
                        for (let headA of myMap.values()) {
                            counter++
                            let head = headA.replaceAll('"', "")
                            headers.push(head)
                        }
                        console.log(jsonData[task.str_header - 1])
                        for (let i = task.str_header - 1; i < jsonData.length; i++) {
                            //console.log(jsonData[i])
                            //
                            myMap = new Map(Object.entries(jsonData[i]));
                            //console.log(myMap)
                            let dt = []
                            for (let headA of myMap.values()) {
                                let find =
                                    console.log(headA)
                                // let head = headA.replaceAll('"', "")
                                // dt.push(head)
                            }
                            data.push(dt)
                        }
                        console.log(data)
                        //displaying the json result into HTML table
                        // for (let i = task.str_header - 2; i < jsonData.length; i++) {
                        //     let data = JSON.stringify(jsonData[i]);
                        //     let str = data.split(",")
                        //
                        //     for (let j = 0; j < str.length; j++) {
                        //         let substr = str[j].split(":")
                        //         if (substr.length > 1) {
                        //             let head = substr[1].replaceAll('"', "")
                        //             headers.push(head)
                        //         }
                        //     }
                        // }

                        //  console.log(headers)
                        displayJsonToHtmlTable(headers, jsonData);
                        //console.log(jsonData)
                    }
                } catch
                    (e) {
                    console.error(e);
                }
            }

            //Method to display the data in HTML Table
            function displayJsonToHtmlTable(headers, jsonData) {
                let table = document.getElementById("json_data");
                if (headers.length > 0) {
                    let htmlData = '<tr>'
                    // var htmlData = '<tr><th>Student Name</th><th>Address</th><th>Email ID</th><th>Age</th></tr>';
                    for (let i = 0; i < headers.length; i++) {

                        htmlData += '<th>' + headers[i] + '</th>';
                    }
                    htmlData += ' </tr>'
                    table.innerHTML = htmlData;
                } else {
                    table.innerHTML = 'There is no data in Excel';
                }
                // if (jsonData.length > 0) {
                //     var htmlData = '<tr><th>Student Name</th><th>Address</th><th>Email ID</th><th>Age</th></tr>';
                //     for (var i = 0; i < jsonData.length; i++) {
                //         var row = jsonData[i];
                //         htmlData += '<tr><td>' + row["Student Name"] + '</td><td>' + row["Address"]
                //             + '</td><td>' + row["Email ID"] + '</td><td>' + row["Age"] + '</td></tr>';
                //     }
                //     table.innerHTML = htmlData;
                // } else {
                //     table.innerHTML = 'There is no data in Excel';
                // }
            }
        </script>
    </main>

{{end}}