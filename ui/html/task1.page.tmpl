<head>
    <script src="/static/js/xlsx.min.js"/>
    <script>
    </script>
</head>
{{template "base" .}}

{{define "main"}}
    <main class="form-main">
        <div class="card">
            <div class="card-header">
                Задача: Загрузка Excel
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">
                    <div class="mb-3">
                        <label for="formFile" class="form-label">Файл для загрузки</label>
                        <input class="form-control" type="file" id="file_upload">
                    </div>
                    <button class="btn btn-primary" onclick="upload()">Выполнить</button>
                </li>
                <li class="list-group-item">
                    <div class="container  table-responsive">
                        <table id="json_data" class="table table-striped table-bordered table-sm table-responsive" ></table>
                    </div>
                </li>
            </ul>

        </div>

        {{/*      */}}

        <script>
            function upload() {
                var files = document.getElementById('file_upload').files;
                if (files.length == 0) {
                    alert("Please choose any file...");
                    return;
                }
                var filename = files[0].name;
                var extension = filename.substring(filename.lastIndexOf(".")).toUpperCase();
                if (extension == '.XLS' || extension == '.XLSX') {
                    //Here calling another method to read excel file into json
                    excelFileToJSON(files[0]);
                } else {
                    alert("Please select a valid excel file.");
                }
            }

            //Method to read excel file and convert it into JSON
            function excelFileToJSON(file) {
                try {
                    var reader = new FileReader();
                    reader.readAsBinaryString(file);
                    reader.onload = function (e) {
                        var data = e.target.result;
                        var workbook = XLSX.read(data, {
                                type: 'binary'
                            }
                        );
                        var result = {};
                        let headers = []
                        var firstSheetName = workbook.SheetNames[0];
                        //reading only first sheet data
                        var jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName]);
                        //displaying the json result into HTML table
                        for (let i = 0; i < jsonData.length; i++) {
                            let data = JSON.stringify(jsonData[i]);
                            let find = data.indexOf('Показатель итог')
                            if (find != -1) {
                                let str = data.split(",")

                                for (let j = 0; j < str.length; j++) {
                                    let substr = str[j].split(":")
                                    if (substr.length > 1) {
                                        let head = substr[1].replaceAll('"', "")
                                        headers.push(head)
                                    }
                                }
                            }
                        }
                        //  console.log(headers)
                        displayJsonToHtmlTable(headers, jsonData);
                        //console.log(jsonData)
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            //Method to display the data in HTML Table
            function displayJsonToHtmlTable(headers, jsonData) {
                let table = document.getElementById("json_data");
                if (headers.length > 0) {
                    let htmlData = '<tr>'
                    // var htmlData = '<tr><th>Student Name</th><th>Address</th><th>Email ID</th><th>Age</th></tr>';
                    for (let i = 0; i < headers.length; i++) {

                        htmlData += '<th>' + headers[i] + '</th>';
                    }
                    htmlData += ' </tr>'
                    table.innerHTML = htmlData;
                } else {
                    table.innerHTML = 'There is no data in Excel';
                }
                // if (jsonData.length > 0) {
                //     var htmlData = '<tr><th>Student Name</th><th>Address</th><th>Email ID</th><th>Age</th></tr>';
                //     for (var i = 0; i < jsonData.length; i++) {
                //         var row = jsonData[i];
                //         htmlData += '<tr><td>' + row["Student Name"] + '</td><td>' + row["Address"]
                //             + '</td><td>' + row["Email ID"] + '</td><td>' + row["Age"] + '</td></tr>';
                //     }
                //     table.innerHTML = htmlData;
                // } else {
                //     table.innerHTML = 'There is no data in Excel';
                // }
            }
        </script>
    </main>

{{end}}